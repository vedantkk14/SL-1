-- Create database for PL/SQL demo
CREATE DATABASE plsql_demo;

-- Select the database
USE plsql_demo;

-- ==========================================================
-- 1. STUDENT ATTENDANCE CHECK (TERM GRANTED / NOT GRANTED)
-- ==========================================================

-- Create student attendance table
CREATE TABLE Stud (
    Roll INT PRIMARY KEY,
    Att DEC(5,2),
    Status CHAR(2)
);

-- Insert sample student attendance records
INSERT INTO Stud VALUES (1, 80, NULL);
INSERT INTO Stud VALUES (2, 70, NULL);
INSERT INTO Stud VALUES (3, 90, NULL);

-- Change delimiter to allow procedure creation
DELIMITER $$

-- Create procedure to check attendance and set term status
CREATE PROCEDURE check_term_proc(IN v_roll INT)
BEGIN
  DECLARE v_att INT;

  -- Fetch attendance for given roll number
  SELECT Att INTO v_att
  FROM Stud
  WHERE Roll = v_roll;

  -- Check attendance and update status
  IF v_att < 75 THEN
    UPDATE Stud SET Status='D' WHERE Roll=v_roll;
    SELECT 'Term not granted' AS result_msg;
  ELSE
    UPDATE Stud SET Status='ND' WHERE Roll=v_roll;
    SELECT 'Term granted' AS result_msg;
  END IF;

END$$
DELIMITER ;

-- Call procedure to test for roll 1
CALL check_term_proc(1);

-- ==========================================================
-- 2. BANK WITHDRAWAL WITH EXCEPTION HANDLING
-- ==========================================================

-- Create account master table
CREATE TABLE account_master (
    acc_no INT PRIMARY KEY,
    balance DEC(10,2)
);

-- Insert account records
INSERT INTO account_master VALUES (101, 10000);
INSERT INTO account_master VALUES (102, 5000);
INSERT INTO account_master VALUES (103, 2000);

-- Change delimiter for procedure creation
DELIMITER $$

-- Procedure to withdraw an amount with balance validation
CREATE PROCEDURE withdraw_amount1(
    IN v_acc_no INT,
    IN v_withdraw DECIMAL(10,2)
)
BEGIN
    DECLARE v_balance DECIMAL(10,2);

    -- Fetch current balance of the account
    SELECT balance INTO v_balance
    FROM account_master
    WHERE acc_no = v_acc_no;

    -- Throw error if withdraw amount > balance
    IF v_withdraw > v_balance THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Error: Withdrawal exceeds current balance!';
    ELSE
        -- Deduct the amount and update balance
        UPDATE account_master
        SET balance = balance - v_withdraw
        WHERE acc_no = v_acc_no;

        -- Show success message
        SELECT CONCAT('Withdrawal successful. Remaining balance: ', v_balance - v_withdraw) AS result_msg;
    END IF;
END$$

DELIMITER ;

-- Call withdrawal procedure
CALL withdraw_amount1(101, 2000);

-- ==========================================================
-- 3. LIBRARY BORROWER + FINE SYSTEM WITH CONDITIONS
-- ==========================================================

-- Create borrower table
CREATE TABLE Borrower (
    Roll_no INT,
    Name VARCHAR(50),
    Date_of_Issue DATE,
    Name_of_Book VARCHAR(50),
    Status CHAR(1)  -- 'I' = Issued, 'R' = Returned
);

-- Create fine table
CREATE TABLE Fine (
    Roll_no INT,
    Date_of_Fine DATE,
    Amt DEC(10,2)
);

-- Insert sample borrower data
INSERT INTO Borrower VALUES (1,'Sudhir',CURDATE(),'Data Science','I');
INSERT INTO Borrower VALUES (2,'Rahul',CURDATE(),'AI Basics','I');
INSERT INTO Borrower VALUES (3,'Divya',CURDATE(),'Python','I');

-- Change delimiter for procedure creation
DELIMITER $$

-- Procedure to return a book and calculate fine
CREATE PROCEDURE return_book(
    IN v_roll INT,
    IN v_book VARCHAR(50)
)
BEGIN
    DECLARE v_date_issue DATE;
    DECLARE v_status CHAR(1);
    DECLARE v_days INT;
    DECLARE v_fine_amt DECIMAL(10,2);
    DECLARE book_not_issued CONDITION FOR SQLSTATE '45000';

    -- Fetch date of issue and status for given book and roll number
    SELECT Date_of_Issue, Status INTO v_date_issue, v_status
    FROM Borrower
    WHERE Roll_no = v_roll AND Name_of_Book = v_book;

    -- Check if book is issued
    IF v_status <> 'I' THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Error: Book is not currently issued!';
    END IF;

    -- Calculate number of days since issue
    SET v_days = DATEDIFF(CURDATE(), v_date_issue);

    -- Calculate fine based on number of days
    IF v_days BETWEEN 15 AND 30 THEN
        SET v_fine_amt = v_days * 5;
    ELSEIF v_days > 30 THEN
        SET v_fine_amt = v_days * 50;
    ELSE
        SET v_fine_amt = v_days * 5;
    END IF;

    -- Insert fine record if applicable
    IF v_fine_amt > 0 THEN
        INSERT INTO Fine(Roll_no, Date_of_Fine, Amt)
        VALUES(v_roll, CURDATE(), v_fine_amt);
    END IF;

    -- Update book status to Returned ('R')
    UPDATE Borrower
    SET Status='R'
    WHERE Roll_no=v_roll AND Name_of_Book=v_book;

    -- Display success message
    SELECT CONCAT('Book returned successfully. Fine amount: ', v_fine_amt) AS result_msg;
END$$

DELIMITER ;

-- Temporarily disable safe update mode
SET SQL_SAFE_UPDATES = 0;

-- Call procedure to return book
CALL return_book(2, 'AI Basics');

-- Re-enable safe update mode
SET SQL_SAFE_UPDATES = 1;
